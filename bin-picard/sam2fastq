#!/bin/bash

usage() {
    NAME=$(basename $0)
    cat <<EOF
  ${NAME} [-goRz] IN_BAM OUT_FASTQ

  This is a wrapper to picard-tools.

  Extracts read sequences and qualities from the input SAM/BAM file and writes
  them into the output file in Sanger fastq format.

  In the RC mode (default is True), if the read is aligned and the alignment is
  to the reverse strand on the genome, the read's sequence from input SAM file
  will be reverse-complemented prior to writing it to fastq in order restore
  correctly the original read sequence as it was generated by the sequencer.

  Inputs:
    IN_BAM    : The input SAM/BAM file
    OUT_FASTQ : The path to the output fastq file
                 
  Options:
    -h      Shows this help message and exits
    -g      Output a fastq file per read group
            [not used -- set to default]
    -o PATH Set the output directory to PATH. Used only when output -g is set.
            [not used -- set to default]
    -P PATH The path to the directory with the picard-tools jars. If unset
            the script will attempt to get value from PICARDTOOLS environment
            variables. If *this* is unset, then the script will fail.
    -R      Set this flag to DISABLE reporting the reverse complement of reads
            aligned to the negative strand.
    -M      Set max heap space for the JVM (-Xmx): defaults to 2g
    -z      Gzip output when done.
EOF
}

PTOOLS=$PICARDTOOLS

INFILE=""
OUTFILE=""
#OUTPUT_PER_RG="false"
#OUTPUT_DIR="."
RE_REVERSE="true"
GZIP=0
XMX="2g"

while getopts 'hgoM:P:R:z' OPTION
do
  case $OPTION in
    h)
      usage
      exit 1
      ;;
    g)
      echo "OUTPUT_PER_RG doesn't do anything"
      OUTPUT_PER_RG="true"
      ;;
    o)
      OUTPUT_DIR="${OPTARG}"
      ;;
    M)
      XMX="${OPTARG}"
      ;;
    P)
      PTOOLS="${OPTARG}"
      ;;
    R)
      RE_REVERSE="false"
      ;;
    z)
      GZIP=1
      ;;
  esac
done

## Jump to first positional argument
shift $(($OPTIND - 1))

## Check to 
INFILE=$1
OUTFILE=$2

if [ ! -f $INFILE ]; then
  echo "Input sam/bam not found"
  exit 1
fi

if [ -f $OUTFILE ]; then
  echo "Output file already exists!"
  exit 1
fi

if [ ! -d $OUTDIR ]; then
  echo "Output directory does not exist"
  exit 1
fi

if [ ! -d $PTOOLS ]; then
  echo "Use -P to set the path to the picard-tools jars, or set the"
  echo "PICARDTOOLS environment variable"
  exit 1
fi

cmd="java -Xmx${XMX} -jar ${PTOOLS}/SamToFastq.jar \
    RE_REVERSE=${RE_REVERSE}                      \
    I=${INFILE} F=${OUTFILE}                      \
    VALIDATION_STRINGENCY=SILENT"

#     OUTPUT_PER_RG=${OUTPUT_PER_RG}
#     OUTPUT_DIR=${OUTPUT_DIR}                      \

echo $cmd
eval $cmd

if [ $GZIP -eq 1 ]; then
  echo "Gzipping file ..."
  gzip -v ${OUTFILE}
fi

